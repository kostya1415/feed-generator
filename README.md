# Сервис генерации товарных фидов

Это проект является примером реализации сервиса генерации товарных фидов. Он позволяет генерировать набор файлов для
различных интеграций в формате yml, оптимально используя оперативную память и хранилище товарных предложений, а так же
даёт возможность гибко прописать фильтры и шаблоны для каждого сервиса.

## TODO

1. Реализовать `App\Repo\Contract\OffersRepoInterface` и `App\Repo\Contract\S3RepoInterface`. (`S3RepoInterface` для
   Minio уже реализован в `App\Repo\MinioS3Repo`)
2. Создать Render классы для своих фидов по примеру `App\UseCase\Render\ExampleRender`
3. Заполнить .env файл

## Место хранения фидов

Для сохранения фидов используется объектное хранилище, работающее
по [Amazon S3 API](https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html)
через библиотеку [aws/aws-sdk-php](https://github.com/aws/aws-sdk-php).

## Команды

### 1. Генерация товарных фидов

```shell
php bin/console app:update-feed
```

Генерирует товарные фиды для всех сервисов.

Этапы работы:

1. Повторный вызов скрипта блокируется, пока не завершится текущий скрипт.
2. Если корзина для фидов по какой то причине не существует, пытаемся создать её.
3. Удаляем временные фиды, если скрипт в прошлый раз отработал неудачно и не смог их удалить на последнем этапе.
4. Создаём пустые временные фиды для всех сервисов.
5. Добавляем во временные фиды шапку (первые теги, в которых указана дата, кодировка, название магазина и т.д.) по
   индивидуальному шаблону для каждого фида
6. Добавляем во временные фиды список категорий.
7. Постранично обходим весь каталог товарных предложений. Проверяем каждый товар на соответствие критериям ассортимента
   каждого фида и кладём его в соответствующие фиды.
8. Добавляем во временные фиды закрывающие теги.
9. Закрываем потоки, по которым вносили изменения во временные фиды.
10. Заменяем старые публичные фиды на копии только что сформированных временных фидов. Сами временные фиды удаляем.
11. Создаём сжатую zip копию указанных фидов. Выполняется та же последовательность действий, что и при вызове
    команды `php bin/console app:feed-zip`
12. Создаём сжатую gzip копию указанных фидов. Выполняется та же последовательность действий, что и при вызове
    команды `php bin/console app:feed-gzip`
13. Выгрузка закончена

### 2. Сжатие товарных фидов в zip

```shell
php bin/console app:feed-zip
```

Команда создана для теста сжатия в zip формат, без предварительного обновления фидов, как в
команде `php bin/console app:update-feed`.

Создаёт сжатую zip копию указанных фидов.

1. Скачиваем потоком фид из S3 в файловое хранилище приложения (потому что сжатие не работает внутри S3).
2. Сжимаем его в zip формат
3. Удаляем не сжатый фид из файлов приложения
4. Загружаем сжатый фид потоком в S3 как временный файл
5. Удаляем сжатый фид из файлов приложения
6. Подменяем старый публичный сжатый фид в S3 на только что загруженный временный фид
7. Удаляем временный фид в S3

Имена фидов для сжатия нужно прописать в config/services.yaml App\UseCase\Action\FeedGzipAction.arguments.$feedNamesStr.
Имя фида должно быть взято из `App\Enum\FeedName`.

### 3. Сжатие товарных фидов в gzip

```shell
php bin/console app:feed-gzip
```

Команда создана для теста сжатия в gzip формат, без предварительного обновления фидов, как в
команде `php bin/console app:update-feed`.

Создаёт сжатую gzip копию указанных фидов.

1. Скачиваем потоком фид из S3 в файловое хранилище приложения (потому что сжатие не работает внутри S3). Причём
   скачиваем сразу в gzip.
2. Загружаем сжатый фид потоком обратно в S3 как временный файл
3. Удаляем сжатый фид из файлов приложения
4. Подменяем старый сжатый фид в S3 на только что загруженный временный файл
5. Удаляем временный файл в S3

Имена фидов для сжатия нужно прописать в config/services.yaml App\UseCase\Action\FeedZipAction.arguments.$feedNamesStr.
Имя фида должно быть взято из `App\Enum\FeedName`.

## Роуты для загрузки фидов

| №   | Название                                                                                   | Путь                                                             | Сжатая версия                                                       |
|-----|--------------------------------------------------------------------------------------------|------------------------------------------------------------------|---------------------------------------------------------------------|
| 1   | Example №1                                                                                 | /integration-services/example/feed.yml                           | /integration-services/example/feed.yml.gz                           |
| 2   | Example №2                                                                                 | /integration-services/example2/feed.yml                          | /integration-services/example2/feed.yml.zip                         |
